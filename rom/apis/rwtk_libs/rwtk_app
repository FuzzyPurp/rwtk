-----------------------------------------------------------------------------
-- Redworks Toolkit
-- Author: MewK
--
-- This program is released under the MIT License (MIT).
-----------------------------------------------------------------------------

-- Using:
os.loadAPI('/rom/apis/rwtk_libs/rwtk_core')

-----------------------------------------------------------------------------
-- Component class
-----------------------------------------------------------------------------

component = rwtk_core.class(function(_self, properties)
	-- Default properties
	_self.border = true
	--_self.focusable = false
	_self.focused = false
	_self.height = false
	_self.padding = 1
	_self.visible = true
	_self.width = false
	_self.x = false
	_self.y = false
	
	-- User properties
	if properties then
		-- Copy properties
		for key, value in pairs(properties) do
			_self[key] = value
		end
	
		-- Check padding
		if not _self.border then
			_self.padding = 0
		end
		
		-- Backup user onKey handler
		if _self.onKey then
			_self.__onKey = _self.onKey
		end
	end
	
	-- Internal onKey handler
	_self.onKey = function(self, keyCode)
		-- Up
		if keyCode == 200 then

		-- Down
		elseif keyCode == 208 then

		-- Left
		elseif keyCode == 203 then

		-- Right
		elseif keyCode == 205 then

		-- Enter
		elseif keyCode == 28 then

		end

		-- Call event handler
		if self.__onKey then
			self.__onKey(self, keyCode)
		end
	end
end)

-- General functions

function component:draw(innerX, innerY, innerWidth, innerHeight)
	-- Calculate inner dimensions
	local _innerX, _innerY, _innerWidth, _innerHeight = self:innerDimensions(innerX, innerY, innerWidth, innerHeight)
	
	-- Call event handler
	if self.onDraw then	
		term.setCursorPos(_innerX, _innerY)
		self.onDraw(self, _innerX, _innerY, _innerWidth, _innerHeight)
	end
end

function component:innerDimensions(innerX, innerY, innerWidth, innerHeight)
	innerX = innerX + self.x + self.padding - 1
	innerY = innerY + self.y + self.padding - 1
	innerWidth = self.width - 2 * self.padding
	innerHeight = self.height - 2 * self.padding
	return innerX, innerY, innerWidth, innerHeight
end

-----------------------------------------------------------------------------
-- Application class
-----------------------------------------------------------------------------

application = rwtk_core.class(function(_self, properties)
	-- Default properties
	_self.focusIndex = 0
	_self.layers = {}
	_self.running = false
	
	-- User properties
	if properties then
		for key, value in pairs(properties) do
			_self[key] = value
		end
	end
end)

function application:getLayer(name)
	for index, layer in ipairs(self.layers) do
		if layer.name == name then
			return layer, index 
		end
	end
	return nil, nil
end

function application:getActiveLayer()
	if self.focusIndex > 0 then
		return self.layers[self.focusIndex]
	end
	return false
end

function application:removeLayer(name)
	-- Get layer
	local layer, index = self:getLayer(name)
	
	-- Remove layer
	if index then
		table.remove(self.layers, index)
		-- Change focus
		if index == self.focusIndex then
			self.focusIndex = self.focusIndex - 1
		end
	end
end
	
function application:addLayer(name, layer)
	-- Remove layer if exists
	self:removeLayer(name)
	
	-- Add layer
	layer.name = name
	layer.parent = self
	table.insert(self.layers, layer)
end

function application:focusLayer(name)
	-- Get layer
	local layer, index = self:getLayer(name)
	
	-- Focus layer
	if index then
		self.focusIndex = index
	else
		self.focusIndex = 0
	end
end

function application:draw()
	term.clear()
	term.setCursorPos(1, 1)

	local activeLayer = self:getActiveLayer()
	for index, layer in ipairs(self.layers) do
		if layer.visible then
			layer:draw()
		end
	end
end

function application:callEvent(eventHandler, ...)
	if self[eventHandler] then 
		self[eventHandler](self, ...) 
	end
	
	local activeLayer = self:getActiveLayer()
	if activeLayer and activeLayer[eventHandler] then
		activeLayer[eventHandler](activeLayer, ...)
	end
end

function application:start()
	self.running = true
	
	-- onStart
	self:callEvent('onStart')
	
	-- Draw screen
	self:draw()
	
	while self.running do
		-- onLoop
		self:callEvent('onLoop')
	
		-- Pull event
		local event, param1, param2 = os.pullEvent()
		
		-- onEvent
		self:callEvent('onEvent', event, param1, param2)
			
		-- onAlarm
		if event == 'alarm' then
			self:callEvent('onAlarm', param1)
		
		-- onChar
		elseif event == 'char' then
			self:callEvent('onChar', param1)
			
		-- onDisk
		elseif event == 'disk' then
			self:callEvent('onDisk', param1)
			
		-- onDiskEject
		elseif event == 'disk_eject' then
			self:callEvent('onDiskEject', param1)
		
		-- onKey
		elseif event == 'key' then
			self:callEvent('onKey', param1)
			
		-- onRednet
		elseif event == 'rednet_message' then
			self:callEvent('onRednet', param1, param2)
			
		-- onRedstone
		elseif event == 'redstone' then
			self:callEvent('onRedstone')
			
		-- onTimer
		elseif event == 'timer' then
			self:callEvent('onTimer', param1)
			
		end
		
		-- Draw screen
		self:draw()
	end
	
	-- onStop
	self:callEvent('onStop')
	
	-- Clear screen
	term.clear()
	term.setCursorPos(1, 1)
end

function application:stop()
	self.running = false
end

-- Factory function
function create(properties)
	return application(properties)
end